<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--suppress ALL -->
<mapper namespace="com.tmall.goods.mapper.GoodsMapper">

    <select id="getGoods" resultType="GoodsDTO">
        SELECT
            t.id,
            t.store_id,
            t.`name`,
            t.simple_desc,
            t.location,
            t3.price,
            t3.market_price,
            t2.pid category_id,
            SUM(t4.quantity) quantity
        FROM
            t_goods t
        INNER JOIN t_goods_category_relation t1 ON t1.goods_id = t.id
        INNER JOIN t_goods_category t2 ON t2.id = t1.category_id
        AND t2.is_delete = 0
        INNER JOIN t_goods_sku t3 ON t3.id = t.sku_id
        AND t3.is_delete = 0
        INNER JOIN t_goods_sku t4 ON t4.goods_id = t.id
        AND t4.is_delete = 0
        WHERE
            t.is_delete = 0
        AND t.id = #{goodsId}
    </select>

    <select id="findPromote" resultType="GoodsGridDTO">
        SELECT
            t.id,
            t.`name`,
            t.img_url,
            t4.price,
            t3.category_id
        FROM
            t_goods t
        INNER JOIN t_goods_category_relation t1 ON t.id = t1.goods_id
        INNER JOIN t_goods_category t2 ON t1.category_id = t2.id
        AND t2.is_delete = 0
        INNER JOIN t_goods_promote_category t3 ON t2.pid = t3.category_id
        AND t3.is_delete = 0
        INNER JOIN t_goods_sku t4 ON t.sku_id = t4.id
        AND t4.is_delete = 0
        WHERE
            t.is_delete = 0
        AND t3.promote_id = #{promoteId}
    </select>

    <select id="findByCategories" resultType="GoodsGridDTO">
        SELECT
            t.id,
            t.`name`,
            t.img_url,
            t3.price,
            t2.pid category_id
        FROM
          `t_goods` t
        INNER JOIN t_goods_category_relation t1 ON t.id = t1.goods_id
        INNER JOIN t_goods_category t2 ON t1.category_id = t2.id
        AND t2.is_delete = 0
        <if test="categories != null">
            AND t2.pid IN
            <foreach collection="categories" open="(" separator="," close=")" item="pid">
                #{pid}
            </foreach>
        </if>
        INNER JOIN t_goods_sku t3 ON t.sku_id = t3.id
        AND t3.is_delete = 0
        WHERE
        t.is_delete = 0
        <if test="notCategories != null">
            AND t2.pid NOT IN
            <foreach collection="notCategories" open="(" separator="," close=")" item="pid">
                #{pid}
            </foreach>
        </if>
        LIMIT #{count}
    </select>

    <select id="storeGoods" resultType="StoreGoodsDTO">
        SELECT
            t.id,
            t.is_show_banner,
            t.is_promote,
            t.`name`,
            t.img_url,
            t1.img_url banner_url,
            t3.price,
            t4.pid category_id
        FROM
            `t_goods` t
        LEFT JOIN t_goods_img t1 ON t.id = t1.goods_id
        AND t.is_show_banner = 1
        AND t1.img_type = 16
        AND t1.is_delete = 0
        INNER JOIN t_goods_category_relation t2 ON t2.goods_id = t.id
        INNER JOIN t_goods_sku t3 ON t.sku_id = t3.id
        INNER JOIN t_goods_category t4 ON t2.category_id = t4.id
        AND t3.is_delete = 0
        WHERE
            t.is_delete = 0
        AND t.store_id = #{storeId}
        AND (
            t.is_show_banner = 1
            OR t.is_promote = 1
        )
    </select>

    <select id="findImgs" resultType="GoodsImgDTO">
        SELECT
            img_type,
            img_url
        FROM
            t_goods_img
        WHERE
            is_delete = 0
        AND goods_id = #{goodsId}
        AND img_type IN (13, 14)
        ORDER BY
            img_type
    </select>

    <select id="findParams" resultType="GoodsParamDTO">
        SELECT
            param_name,
            param_value
        FROM
            t_goods_param
        WHERE
            is_delete = 0
        AND goods_id = #{goodsId}
    </select>

    <select id="findSku" resultType="GoodsSkuDTO">
        SELECT
            t.id,
            t.attrs,
            t.price,
            t.market_price,
            t.quantity
        FROM
            t_goods_sku t
        WHERE
            t.is_delete = 0
        AND t.goods_id = #{goodsId}
    </select>


    <select id="getFreight" resultType="Float">
        SELECT
            cost
        FROM
            t_goods_freight
        WHERE
            is_delete = 0
        AND goods_id = #{goodsId}
        AND target_city_code = #{cityCode}
    </select>

    <select id="findEsGoods" resultType="EsGoodsDTO">
        SELECT
            t.id,
            t.`name`,
            min(t8.price) price,
            t.img_url,
            t1.`name` store,
            t2.brand_name brand,
            GROUP_CONCAT(DISTINCT t3.category_id) categoryIds,
            GROUP_CONCAT(DISTINCT t4.`name`) categories,
            CONCAT(
                GROUP_CONCAT(DISTINCT t4.`name`),
                ',',
                GROUP_CONCAT(DISTINCT t5.`name`),
                ',',
                GROUP_CONCAT(DISTINCT t7.`name`)
            ) allCategories
        FROM
            t_goods t
        INNER JOIN t_store t1 ON t1.id = t.store_id
        AND t1.is_delete = 0
        INNER JOIN t_goods_brand t2 ON t2.id = t.brand_id
        AND t2.is_delete = 0
        INNER JOIN t_goods_category_relation t3 ON t3.goods_id = t.id
        INNER JOIN t_goods_category t4 ON t4.id = t3.category_id
        AND t4.is_delete = 0 -- 4
        INNER JOIN t_goods_category t5 ON t5.id = t4.pid
        AND t5.is_delete = 0 -- 3
        INNER JOIN t_goods_category t6 ON t6.id = t5.pid
        AND t6.is_delete = 0 -- 2
        INNER JOIN t_goods_category t7 ON t7.id = t6.pid
        AND t7.is_delete = 0 -- 1
        INNER JOIN t_goods_sku t8 ON t8.goods_id = t.id
        AND t8.is_delete = 0
        GROUP BY
            t.id
    </select>
</mapper>